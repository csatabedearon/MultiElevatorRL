<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Multi-Elevator Simulator</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            /* Light Theme Variables */
            --body-bg: #f0f2f5;
            --primary: #4361ee;
            --primary-light: #4895ef;
            --secondary: #3a0ca3;
            --success: #4cc9f0;
            --danger: #f72585;
            --warning: #ffd60a;
            --light: #f8f9fa;
            --card-bg: white;
            --dark: #2b2d42;
            --gray: #8d99ae;
            --text-color: #2b2d42;
            --text-muted: #6c757d;
            --border-color: #e0e0e0;
            --transition: all 0.3s ease;
            --floor-height-desktop: 80px;
            --floor-height-tablet: 60px;
            --floor-height-mobile: 50px;
            --elevator-size-desktop: 70px;
            --elevator-size-tablet: 55px;
            --elevator-size-mobile: 45px;
            /* New variables for elevator and shaft styling */
            --shaft-bg: #3a3a3a;
            --shaft-rail-color: #555555;
            --elevator-bg-start: #bdbdbd;
            --elevator-bg-mid: #757575;
            --elevator-bg-end: #9e9e9e;
            --elevator-border: #424242;
            --elevator-door-line: rgba(0, 0, 0, 0.3);
            --elevator-text-color: #eeeeee;
            --floor-edge-color: #666666;
            --floor-bg: #f8f9fa;
            --floor-border: #bdbdbd;
            --floor-button-bg: #e9ecef;
            --floor-button-hover-bg: var(--primary-light);
            --floor-button-active-bg: var(--danger);
            --floor-button-text: var(--dark);
            --floor-button-hover-text: white;
            --floor-button-active-text: white;
            --modal-bg: white;
            --modal-overlay-bg: rgba(0, 0, 0, 0.6);
            --input-bg: white;
            --input-border: #e9ecef;
            --input-focus-border: var(--primary);
            --chart-label-color: #666;
            --chart-grid-color: rgba(0, 0, 0, 0.1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
            margin: 0;
            padding: 0;
            background-color: var(--body-bg);
            color: var(--text-color);
            line-height: 1.6;
            font-size: 16px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 1rem;
            width: 100%;
        }

        .header {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: var(--light);
            padding: 1rem 1.5rem;
            text-align: center;
            border-radius: 12px;
            margin-bottom: 1.5rem;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.75rem;
        }

        .header h1 {
            font-size: 1.75rem;
            font-weight: 600;
            margin: 0;
        }

        .config-button {
            background-color: var(--primary-light);
            color: white;
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: var(--transition);
            font-size: 0.9rem;
        }

        .config-button:hover {
            background-color: var(--primary);
        }

        .dashboard {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            grid-template-areas:
                "viz controls stats"
                "viz graphs graphs";
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .viz-area { grid-area: viz; }
        .controls-area { grid-area: controls; }
        .stats-area { grid-area: stats; }
        .graphs-area { grid-area: graphs; }

        .card {
            background-color: var(--card-bg);
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            padding: 1.5rem;
            transition: var(--transition);
            display: flex;
            flex-direction: column;
        }

        .card h2 {
            font-size: 1.2rem;
            margin-bottom: 1rem;
            color: var(--secondary);
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 0.5rem;
        }

        .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 15px rgba(0, 0, 0, 0.1);
        }

        .building-container {
             overflow-x: auto;
             padding-bottom: 10px;
        }

        .building {
            display: flex;
            height: auto;
            position: relative;
            overflow: visible;
            margin-bottom: 20px;
            min-width: 300px;
            background-color: #e0e0e0;
        }

        .floors {
            display: flex;
            flex-direction: column-reverse;
            flex-grow: 1;
            height: auto;
        }

        .floor {
            min-height: var(--floor-height-desktop);
            display: flex;
            border-bottom: 2px solid var(--floor-border);
            position: relative;
            transition: background-color 0.3s ease;
            align-items: center;
            padding: 0 10px;
            background-color: var(--floor-bg);
            border-right: 4px solid var(--floor-edge-color);
            box-sizing: border-box;
        }

        .floor:last-child {
             border-bottom: none;
        }

        .floor:hover {
            background-color: rgba(67, 97, 238, 0.05);
        }

        .floor-info {
            width: 120px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            padding: 0.5rem 0.5rem;
            background-color: var(--light);
            border-right: 1px dashed var(--gray);
            font-size: 0.85rem;
            flex-shrink: 0;
        }

        .floor-number {
            font-weight: 600;
            color: var(--secondary);
        }

        .waiting-count {
            font-size: 0.8rem;
            color: var(--gray);
        }

        .floor-button-container {
            margin-left: auto;
            padding-left: 10px;
        }

        .floor-button {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background-color: var(--floor-button-bg);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: var(--transition);
            border: none;
            font-size: 1rem;
            font-weight: bold;
            color: var(--floor-button-text);
        }

        .floor-button:hover {
            background-color: var(--floor-button-hover-bg);
            color: var(--floor-button-hover-text);
        }

        .floor-button.active {
            background-color: var(--floor-button-active-bg);
            color: var(--floor-button-active-text);
            animation: pulse 1.5s infinite;
        }

        .elevator-shaft {
            width: calc(var(--elevator-size-desktop) + 10px);
            height: 100%;
            position: absolute;
            background: linear-gradient(to right, #2b2b2b, var(--shaft-bg), #2b2b2b);
            border-radius: 4px;
            right: 0;
            top: 0;
            bottom: 0;
            box-shadow: inset 3px 0 8px rgba(0, 0, 0, 0.5);
            z-index: 0;
        }

        .elevator-shaft::before,
        .elevator-shaft::after {
            content: '';
            position: absolute;
            top: 0;
            bottom: 0;
            width: 4px;
            background-color: var(--shaft-rail-color);
            border-radius: 2px;
            box-shadow: inset 1px 0 2px rgba(0,0,0,0.6);
            z-index: 1;
        }

        .elevator-shaft::before {
            left: 6px;
        }

        .elevator-shaft::after {
            right: 6px;
        }

        .elevator {
            position: absolute;
            width: var(--elevator-size-desktop);
            height: var(--elevator-size-desktop);
            background: linear-gradient(160deg, var(--elevator-bg-start) 0%, var(--elevator-bg-mid) 50%, var(--elevator-bg-end) 100%);
            border: 1px solid var(--elevator-border);
            border-radius: 6px;
            transition: transform 0.5s cubic-bezier(0.4, 0, 0.2, 1);
            color: var(--elevator-text-color);
            text-shadow: 1px 1px 2px rgba(0,0,0,0.6);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            gap: 2px;
            bottom: 5px;
            left: 5px;
            font-size: 0.8rem;
            text-align: center;
            z-index: 2;
        }

        .elevator .elevator-id {
             font-weight: bold;
        }

        .elevator .direction {
            font-size: 1.1em;
            font-weight: bold;
            line-height: 1;
        }

        .elevator .passenger-count {
            font-size: 0.85em;
            background: rgba(0, 0, 0, 0.2);
            padding: 1px 6px;
            border-radius: 10px;
            line-height: 1;
        }

        .btn {
            padding: 0.6rem 1.2rem;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: var(--transition);
            font-weight: 600;
            font-size: 0.85rem;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.4rem;
            line-height: 1.2;
        }

        .btn-primary {
            background-color: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background-color: var(--primary-light);
            transform: translateY(-1px);
        }

        .btn-danger {
            background-color: var(--danger);
            color: white;
        }

        .btn-danger:hover {
            background-color: #e91e63;
            transform: translateY(-1px);
        }

        .control-panel {
            margin-top: 1rem;
        }

        .control-group {
            margin-bottom: 1rem;
        }

        .control-label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: var(--dark);
            font-size: 0.9rem;
        }

        #modelFile {
            margin: 0.5rem 0 1rem 0;
            padding: 0.5rem;
            border: 1px solid #e0e0e0;
            border-radius: 4px;
            width: 100%;
            font-size: 0.85rem;
        }

        .button-container {
            display: flex;
            gap: 0.75rem;
            margin-bottom: 1rem;
            flex-wrap: wrap;
        }

        .slider-container {
            margin-bottom: 1rem;
        }

        .slider-container label {
            display: block;
            margin-bottom: 0.3rem;
            font-weight: 500;
            font-size: 0.85rem;
        }

        .slider-container input[type="range"] {
            width: 100%;
            margin-bottom: 0.1rem;
            cursor: pointer;
        }

        .slider-value {
            font-size: 0.8rem;
            color: var(--gray);
            display: inline-block;
            min-width: 30px;
        }

        #stats {
             font-size: 0.9rem;
             line-height: 1.5;
        }
        #stats p {
            margin-bottom: 0.5rem;
        }
        #stats hr {
            margin: 0.75rem 0;
            border: none;
            border-top: 1px solid #eee;
        }
        #stats h3 {
            font-size: 1rem;
            margin-bottom: 0.5rem;
            color: var(--secondary);
        }
        .elevator-status-card {
            margin: 0.5rem 0;
            padding: 0.75rem;
            background-color: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            font-size: 0.85rem;
        }
        .elevator-status-card strong {
            color: var(--primary);
        }

        .graphs-area {
             display: grid;
             grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
             gap: 1rem;
        }

        .graph-container {
            height: 250px;
            padding: 1rem;
            background-color: var(--card-bg);
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }
        .graph-container canvas {
             max-width: 100%;
             background-color: transparent;
        }

        .status-message {
            margin-top: 1rem;
            padding: 0.75rem;
            border-radius: 6px;
            font-weight: 500;
            font-size: 0.85rem;
            display: none;
        }
        .status-message.visible {
            display: block;
        }
        .status-message.success {
            background-color: #e8f5e9;
            color: #2e7d32;
            border: 1px solid #a5d6a7;
        }
        .status-message.error {
            background-color: #ffebee;
            color: #c62828;
            border: 1px solid #ef9a9a;
        }

        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.6);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            padding: 1rem;
        }

        .modal {
            background-color: var(--modal-bg);
            padding: 1.5rem;
            border-radius: 12px;
            width: 95%;
            max-width: 500px;
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.2);
        }

        .modal h2 {
            margin-bottom: 1.5rem;
            color: var(--secondary);
            font-size: 1.4rem;
        }

        .form-group {
            margin-bottom: 1rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.4rem;
            font-weight: 600;
            color: var(--dark);
            font-size: 0.9rem;
        }

        .form-group input[type="number"] {
            width: 100%;
            padding: 0.6rem;
            border: 2px solid var(--input-border);
            border-radius: 8px;
            font-size: 1rem;
            transition: var(--transition);
            background-color: var(--input-bg);
        }

        .form-group input[type="number"]:focus {
            outline: none;
            border-color: var(--input-focus-border);
        }

        .button-group {
            display: flex;
            gap: 0.75rem;
            margin-top: 1.5rem;
            flex-wrap: wrap;
        }

        .episode-summary {
             max-width: 600px;
        }

        .episode-summary h2 {
            border-bottom: 2px solid var(--light);
            padding-bottom: 0.5rem;
        }

        .episode-summary .stats-grid {
            display: grid;
             grid-template-columns: 1fr;
            gap: 0.75rem;
        }

        .episode-summary .stat-item {
            background: var(--light);
            padding: 0.75rem;
            border-radius: 8px;
            transition: var(--transition);
        }

        .episode-summary .stat-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
        }

        .episode-summary .stat-label {
            font-size: 0.8rem;
            color: var(--gray);
            margin-bottom: 0.2rem;
        }

        .episode-summary .stat-value {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--secondary);
        }

        @keyframes pulse {
            0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(247, 37, 133, 0.4); }
            70% { transform: scale(1.05); box-shadow: 0 0 0 10px rgba(247, 37, 133, 0); }
            100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(247, 37, 133, 0); }
        }

        @media (min-width: 577px) {
             .episode-summary .stats-grid {
                  grid-template-columns: repeat(2, 1fr);
             }
             .header {
                 flex-direction: row;
                 justify-content: space-between;
             }
        }

        @media (max-width: 992px) {
             .dashboard {
                  grid-template-columns: 1fr 1fr;
                  grid-template-areas:
                       "viz controls"
                       "viz stats"
                       "graphs graphs";
             }
             .floor { min-height: var(--floor-height-tablet); }
             .elevator {
                 width: var(--elevator-size-tablet);
                 height: var(--elevator-size-tablet);
                 font-size: 0.75rem;
                 border-radius: 5px;
             }
             .elevator-shaft { width: calc(var(--elevator-size-tablet) + 10px); }
             .floor-info { width: 100px; }
             .graph-container { height: 220px; }
             .elevator-shaft::before, .elevator-shaft::after { width: 3px; }
             .elevator-shaft::before { left: 5px; }
             .elevator-shaft::after { right: 5px; }
             .floor { border-right-width: 3px; }
        }

        @media (max-width: 576px) {
            body { font-size: 14px; }
            .container { padding: 0.5rem; }
            .header {
                 padding: 0.75rem 1rem;
                 border-radius: 0;
                 margin: -0.5rem -0.5rem 1rem -0.5rem;
                 flex-direction: column;
                 gap: 0.5rem;
            }
            .header h1 { font-size: 1.4rem; }
            .dashboard {
                grid-template-columns: 1fr;
                grid-template-areas:
                    "viz"
                    "controls"
                    "stats"
                    "graphs";
                gap: 1rem;
            }
            .card { padding: 1rem; }
            .card h2 { font-size: 1.1rem; margin-bottom: 0.75rem;}

            .floor { min-height: var(--floor-height-mobile); }
             .elevator {
                 width: var(--elevator-size-mobile);
                 height: var(--elevator-size-mobile);
                 font-size: 0.65rem;
                 border-radius: 4px;
                 gap: 1px;
             }
             .elevator-shaft { width: calc(var(--elevator-size-mobile) + 8px); }
             .elevator .direction { font-size: 1em; }
             .elevator .passenger-count { font-size: 0.8em; padding: 1px 4px; }

            .floor-info {
                width: 80px;
                padding: 0.25rem 0.4rem;
                font-size: 0.75rem;
            }
            .floor-button { width: 28px; height: 28px; font-size: 0.9rem;}

            .btn { padding: 0.5rem 1rem; font-size: 0.8rem; }
            .button-container { gap: 0.5rem; }

            #modelFile { font-size: 0.8rem; }
            .slider-container label { font-size: 0.8rem; }
            .slider-value { font-size: 0.75rem; }

            #stats { font-size: 0.85rem; }
            #stats h3 { font-size: 0.95rem; }
            .elevator-status-card { padding: 0.6rem; font-size: 0.75rem;}

            .graphs-area { gap: 0.75rem; }
            .graph-container { height: 200px; padding: 0.75rem; }

            .modal { padding: 1rem; }
            .modal h2 { font-size: 1.2rem; margin-bottom: 1rem; }
            .form-group label { font-size: 0.85rem; }
            .form-group input[type="number"] { font-size: 0.9rem; padding: 0.5rem; }
            .button-group { gap: 0.5rem; margin-top: 1rem; }

             .episode-summary .stat-label { font-size: 0.75rem; }
             .episode-summary .stat-value { font-size: 1rem; }
        }

        /* Dark Mode Styles */
        [data-theme="dark"] {
            --body-bg: #1a1a2e;
            --primary: #7f5af0;
            --primary-light: #9d7fee;
            --secondary: #c738bd;
            --success: #2cb67d;
            --danger: #ef4565;
            --warning: #ffd369;
            --light: #2e2e48;
            --card-bg: #161625;
            --dark: #e0e0e0;
            --gray: #a1a1aa;
            --text-color: #e0e0e0;
            --text-muted: #a1a1aa;
            --border-color: #3a3a59;
            --shaft-bg: #1f1f38;
            --shaft-rail-color: #44446a;
            --elevator-bg-start: #4a4a6a;
            --elevator-bg-mid: #3a3a5a;
            --elevator-bg-end: #424262;
            --elevator-border: #5a5a7a;
            --elevator-text-color: #f0f0f0;
            --floor-edge-color: #505070;
            --floor-bg: #2e2e48;
            --floor-border: #4a4a6a;
            --floor-button-bg: #3a3a59;
            --floor-button-hover-bg: var(--primary-light);
            --floor-button-active-bg: var(--danger);
            --floor-button-text: var(--text-color);
            --floor-button-hover-text: #161625;
            --floor-button-active-text: var(--light);
            --modal-bg: #1f1f38;
            --modal-overlay-bg: rgba(0, 0, 0, 0.7);
            --input-bg: #2e2e48;
            --input-border: #4a4a6a;
            --chart-label-color: var(--text-muted);
            --chart-grid-color: rgba(255, 255, 255, 0.1);
        }

        /* Theme Toggle Button */
        #themeToggle {
            background-color: transparent;
            border: 1px solid var(--light);
            color: var(--light);
            padding: 0.5rem;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.2rem;
            transition: var(--transition);
            margin-left: auto;
        }

        #themeToggle:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }
    </style>
</head>
<body>
    <div id="welcomeModal" class="modal-overlay">
        <div class="modal">
            <h2>Welcome to Multi-Elevator Simulator</h2>
            <p>Please configure your elevator system:</p>
            <div class="form-group">
                <label for="numElevators">Number of Elevators (1-10):</label>
                <input type="number" id="numElevators" min="1" max="10" value="3">
            </div>
            <div class="form-group">
                <label for="numFloors">Number of Floors (2-20):</label>
                <input type="number" id="numFloors" min="2" max="20" value="10">
            </div>
            <div class="button-group">
                <button class="btn btn-primary" onclick="updateConfiguration()">Update & Start</button>
                <button id="overrideButton" class="btn btn-danger" style="display: none;" onclick="updateConfiguration(true)">
                    Override & Start
                </button>
            </div>
             <div id="configStatusMessage" class="status-message" style="margin-top: 1rem;"></div>
        </div>
    </div>

    <div id="episodeSummaryModal" class="modal-overlay" style="display: none;">
        <div class="modal episode-summary">
            <h2>Episode Summary</h2>
            <div class="stats-grid">
                <div class="stat-item">
                    <div class="stat-label">Total Reward</div>
                    <div class="stat-value" id="totalReward">-</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">Avg Reward / Step</div>
                    <div class="stat-value" id="avgReward">-</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">Passengers Served</div>
                    <div class="stat-value" id="passengersServed">-</div>
                </div>
                 <div class="stat-item">
                    <div class="stat-label">Total Generated</div>
                    <div class="stat-value" id="passengersGenerated">-</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">Completion Rate</div>
                    <div class="stat-value" id="completionRate">-</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">Average Wait Time</div>
                    <div class="stat-value" id="avgWaitTime">-</div>
                </div>
                 <div class="stat-item">
                    <div class="stat-label">Min Wait Time</div>
                    <div class="stat-value" id="minWaitTime">-</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">Max Wait Time</div>
                    <div class="stat-value" id="maxWaitTime">-</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">Total Steps</div>
                    <div class="stat-value" id="totalSteps">-</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">Avg Passengers / Step</div>
                    <div class="stat-value" id="avgPassengersPerStep">-</div>
                </div>
                 <div class="stat-item">
                    <div class="stat-label">Mode Used</div>
                    <div class="stat-value" id="modeUsed">-</div>
                </div>
            </div>
            <div class="button-group" style="margin-top: 1.5rem;">
                <button class="btn btn-primary" onclick="document.getElementById('episodeSummaryModal').style.display='none'">Close</button>
                <button class="btn btn-primary" onclick="startNewEpisode()">Start New Episode</button>
            </div>
        </div>
    </div>

    <div class="container">
        <div class="header">
            <h1>Multi-Elevator Sim</h1>
            <button class="config-button" onclick="showConfigModal()">Change Config</button>
            <button id="themeToggle" class="btn">ðŸŒ™</button>
        </div>

        <div class="dashboard">
            <div class="card viz-area">
                <h2>Elevator System</h2>
                 <div class="building-container">
                    <div class="building">
                        <div class="floors">
                        </div>
                    </div>
                 </div>
            </div>

            <div class="card controls-area">
                 <h2>Controls</h2>
                 <div class="control-panel">
                    <div class="control-group">
                        <label for="modelFile" class="control-label">Load Trained Model (Optional):</label>
                        <input type="file" id="modelFile" accept=".zip" onchange="handleFileSelect(this)"/>
                        <button class="btn btn-secondary" id="loadModelBtn" onclick="loadModel()" disabled>Load Model</button>
                        <span id="loadedModelInfo" style="font-size: 0.8rem; color: var(--gray); margin-left: 5px;"></span>
                    </div>

                    <div class="control-group button-container">
                        <button class="btn btn-primary" id="startBtn" onclick="startSimulation()" disabled>Start</button>
                        <button class="btn btn-danger" id="stopBtn" onclick="stopSimulation()" disabled>Stop</button>
                         <button class="btn btn-warning" id="pauseButton" onclick="togglePause()" disabled>Pause</button>
                        <button class="btn btn-secondary" id="resetBtn" onclick="resetSimulation()">Reset Sim</button>
                    </div>

                    <div class="control-group slider-container">
                        <label for="passengerRate" class="control-label">Passenger Rate:</label>
                        <input type="range" id="passengerRate" min="0" max="1" step="0.05" value="0.1">
                        <span class="slider-value" id="rateValue">0.1</span>
                    </div>

                    <div class="control-group slider-container">
                        <label for="simulationSpeed" class="control-label">Sim Speed (sec/step):</label>
                        <input type="range" id="simulationSpeed" min="0.1" max="2" step="0.1" value="1.0">
                        <span class="slider-value" id="speedValue">1.0</span>
                    </div>

                    <div class="control-group slider-container">
                        <label for="maxSteps" class="control-label">Max Steps:</label>
                        <input type="range" id="maxSteps" min="100" max="5000" step="100" value="1000">
                        <span class="slider-value" id="maxStepsValue">1000</span>
                    </div>

                    <div id="statusMessage" class="status-message"></div>
                 </div>
            </div>

            <div class="card stats-area">
                <h2>System Stats</h2>
                <div id="stats">
                    <p>Waiting for simulation data...</p>
                </div>
            </div>

            <div class="graphs-area">
                 <div class="graph-container">
                     <canvas id="passengersChart"></canvas>
                 </div>
                 <div class="graph-container">
                     <canvas id="rewardChart"></canvas>
                 </div>
                 <div class="graph-container">
                     <canvas id="waitTimeChart"></canvas>
                 </div>
             </div>
        </div>
    </div>

    <script src="https://cdn.socket.io/4.7.4/socket.io.min.js"></script>
    <script>
        const socket = io();
        let charts = {
            passengers: null,
            reward: null,
            waitTime: null
        };
        let simulationRunning = false;
        let simulationPaused = false;
        let modelLoaded = false;

        const maxDataPoints = 100;
        const chartData = {
            passengers: [], waiting: [], rewards: [], waitTimes: [], timestamps: []
        };

        const elements = {
            numElevatorsInput: document.getElementById('numElevators'),
            numFloorsInput: document.getElementById('numFloors'),
            rateSlider: document.getElementById('passengerRate'),
            rateValue: document.getElementById('rateValue'),
            speedSlider: document.getElementById('simulationSpeed'),
            speedValue: document.getElementById('speedValue'),
            maxStepsSlider: document.getElementById('maxSteps'),
            maxStepsValue: document.getElementById('maxStepsValue'),
            statusMessage: document.getElementById('statusMessage'),
            configStatusMessage: document.getElementById('configStatusMessage'),
            modelFileInput: document.getElementById('modelFile'),
            loadModelBtn: document.getElementById('loadModelBtn'),
            loadedModelInfo: document.getElementById('loadedModelInfo'),
            startBtn: document.getElementById('startBtn'),
            stopBtn: document.getElementById('stopBtn'),
            pauseButton: document.getElementById('pauseButton'),
            resetBtn: document.getElementById('resetBtn'),
            statsDiv: document.getElementById('stats'),
            buildingDiv: document.querySelector('.building'),
            floorsDiv: document.querySelector('.floors'),
            welcomeModal: document.getElementById('welcomeModal'),
            episodeSummaryModal: document.getElementById('episodeSummaryModal'),
            overrideButton: document.getElementById('overrideButton'),
            themeToggleBtn: document.getElementById('themeToggle')
        };

        elements.rateSlider.addEventListener('input', function() {
            elements.rateValue.textContent = this.value;
            throttledUpdate(updatePassengerRate, this.value);
        });
        elements.speedSlider.addEventListener('input', function() {
            elements.speedValue.textContent = this.value;
            throttledUpdate(updateSimulationSpeed, this.value);
        });
        elements.maxStepsSlider.addEventListener('input', function() {
            elements.maxStepsValue.textContent = this.value;
            throttledUpdate(updateMaxSteps, this.value);
        });

        let throttleTimer = {};
        function throttledUpdate(func, value) {
            const funcName = func.name;
            if (throttleTimer[funcName]) {
                clearTimeout(throttleTimer[funcName]);
            }
            throttleTimer[funcName] = setTimeout(() => {
                func(value);
                throttleTimer[funcName] = null;
            }, 150);
        }

        socket.on('connect', () => {
            console.log('Connected to server');
            showStatus('Connected to server', false, elements.statusMessage);
        });

        socket.on('disconnect', () => {
             console.log('Disconnected from server');
             showStatus('Disconnected. Attempting to reconnect...', true, elements.statusMessage);
             setSimulationState(false);
        });

        socket.on('stats_update', (data) => {
             if (!simulationRunning || simulationPaused) return;

             updateVisualization(data);
             updateStatsDisplay(data);
             updateCharts(data);
        });

        socket.on('episode_summary', (data) => {
            console.log("Episode Summary Received:", data);
            setSimulationState(false);
            showEpisodeSummary(data);
        });

        function updateVisualization(data) {
            const floorElement = elements.floorsDiv.querySelector('.floor');
            const floorHeight = floorElement ? floorElement.offsetHeight : 60;

            data.elevator_positions.forEach((position, index) => {
                const elevator = document.getElementById(`elevator-${index}`);
                if (elevator) {
                    const bottomPosition = position * floorHeight;
                    elevator.style.transform = `translateY(-${bottomPosition}px)`;

                    const passengerCount = data.elevator_passengers[index];
                    const passengerCountElement = elevator.querySelector('.passenger-count');
                    if (passengerCountElement) passengerCountElement.textContent = passengerCount;

                    const directionIndicator = elevator.querySelector('.direction');
                    if (directionIndicator) {
                        const direction = data.elevator_directions[index];
                        directionIndicator.textContent = direction === 1 ? 'â†‘' : direction === 2 ? 'â†“' : 'â€¢';
                    }
                }
            });

            const numFloors = elements.floorsDiv.children.length;
            for (let floor = 0; floor < numFloors; floor++) {
                 const waitingCountElement = document.getElementById(`waiting-${floor}`);
                 const button = elements.floorsDiv.querySelector(`.floor[data-floor-index="${floor}"] .floor-button`);
                 const count = data.waiting_passengers[floor] || 0;

                 if (waitingCountElement) {
                     waitingCountElement.textContent = `Waiting: ${count}`;
                 }
                 if (button) {
                     button.classList.toggle('active', count > 0);
                 }
            }
        }

        function updateStatsDisplay(data) {
            const totalPassengersInElevators = data.elevator_passengers.reduce((a, b) => a + b, 0);
            const totalWaitingPassengers = data.waiting_passengers.reduce((a, b) => a + b, 0);

            elements.statsDiv.innerHTML = `
                <p><strong>Step:</strong> ${data.current_step + 1} / ${data.max_steps}</p>
                <p><strong>Reward:</strong> ${data.reward.toFixed(2)}</p>
                <p><strong style="color: ${data.using_model ? 'var(--success)' : 'var(--warning)'};">Mode:</strong> ${data.using_model ? 'Trained Model' : 'Random Actions'}</p>
                <p><strong>Avg Wait Time (current):</strong> ${data.avg_wait_time.toFixed(1)} steps</p>
                <p><strong>Passengers (Waiting):</strong> ${totalWaitingPassengers}</p>
                <p><strong>Passengers (In Elevators):</strong> ${totalPassengersInElevators}</p>
                <p><strong>Passenger Rate:</strong> ${(data.passenger_rate * 100).toFixed(0)}%</p>
                <p><strong>Sim Speed:</strong> ${data.simulation_speed.toFixed(1)}s/step</p>
                <hr>
                <h3>Elevator Status:</h3>
                ${data.elevator_positions.map((pos, i) => `
                    <div class="elevator-status-card">
                        <strong>Elevator ${i + 1}:</strong> Floor ${pos} |
                        Dir: ${['Idle', 'Up', 'Down'][data.elevator_directions[i]]} |
                        Passengers: ${data.elevator_passengers[i]}
                    </div>
                `).join('')}
            `;

            updateSliderIfNeeded(elements.rateSlider, elements.rateValue, data.passenger_rate);
            updateSliderIfNeeded(elements.speedSlider, elements.speedValue, data.simulation_speed);
            updateSliderIfNeeded(elements.maxStepsSlider, elements.maxStepsValue, data.max_steps);
        }

        function updateSliderIfNeeded(slider, valueDisplay, serverValue) {
            const currentValue = slider.type === 'range' ? parseFloat(slider.value) : parseInt(slider.value);
            const tolerance = slider.step ? parseFloat(slider.step) / 2 : 0.01;
             if (Math.abs(currentValue - serverValue) > tolerance) {
                slider.value = serverValue;
                valueDisplay.textContent = serverValue.toFixed ? serverValue.toFixed(slider.step >= 1 ? 0 : (slider.step >= 0.1 ? 1 : 2)) : serverValue;
            }
        }

        function updateCharts(data) {
            if (!charts.passengers || !data) return;

            const timestamp = new Date().toLocaleTimeString();
            const totalPassengers = data.elevator_passengers.reduce((a, b) => a + b, 0);
            const totalWaiting = data.waiting_passengers.reduce((a, b) => a + b, 0);

            chartData.timestamps.push(timestamp);
            chartData.passengers.push(totalPassengers);
            chartData.waiting.push(totalWaiting);
            chartData.rewards.push(data.reward);
            chartData.waitTimes.push(data.avg_wait_time);

            if (chartData.timestamps.length > maxDataPoints) {
                chartData.timestamps.shift();
                chartData.passengers.shift();
                chartData.waiting.shift();
                chartData.rewards.shift();
                chartData.waitTimes.shift();
            }

            charts.passengers.data.labels = chartData.timestamps;
            charts.passengers.data.datasets[0].data = chartData.passengers;
            charts.passengers.data.datasets[1].data = chartData.waiting;
            charts.passengers.update('none');

            charts.reward.data.labels = chartData.timestamps;
            charts.reward.data.datasets[0].data = chartData.rewards;
            charts.reward.update('none');

            charts.waitTime.data.labels = chartData.timestamps;
            charts.waitTime.data.datasets[0].data = chartData.waitTimes;
            charts.waitTime.update('none');
        }

        function resetCharts() {
             chartData.timestamps = [];
             chartData.passengers = [];
             chartData.waiting = [];
             chartData.rewards = [];
             chartData.waitTimes = [];

             if(charts.passengers) {
                charts.passengers.data.labels = [];
                charts.passengers.data.datasets.forEach(dataset => dataset.data = []);
                charts.passengers.update('none');
             }
            if(charts.reward) {
                charts.reward.data.labels = [];
                charts.reward.data.datasets[0].data = [];
                charts.reward.update('none');
            }
             if(charts.waitTime) {
                charts.waitTime.data.labels = [];
                charts.waitTime.data.datasets[0].data = [];
                charts.waitTime.update('none');
             }
        }

        function showStatus(message, isError = false, element = elements.statusMessage) {
            if (!element) return;
            element.className = 'status-message ' + (isError ? 'error' : 'success') + ' visible';
            element.textContent = message;
            if (!isError) {
                setTimeout(() => {
                     if (element.textContent === message) {
                         element.classList.remove('visible');
                     }
                }, 4000);
            }
        }

         function handleFileSelect(input) {
             elements.loadModelBtn.disabled = !input.files || input.files.length === 0;
         }

        function setSimulationState(isRunning, isPaused = false) {
            simulationRunning = isRunning;
            simulationPaused = isPaused;

            elements.startBtn.disabled = isRunning;
            elements.stopBtn.disabled = !isRunning;
            elements.pauseButton.disabled = !isRunning;
            elements.resetBtn.disabled = isRunning;

            elements.numElevatorsInput.disabled = isRunning || modelLoaded;
            elements.numFloorsInput.disabled = isRunning || modelLoaded;
            elements.loadModelBtn.disabled = isRunning || !elements.modelFileInput.files || elements.modelFileInput.files.length === 0;
            elements.modelFileInput.disabled = isRunning;

            if (isRunning) {
                elements.pauseButton.textContent = isPaused ? 'Resume' : 'Pause';
            } else {
                elements.pauseButton.textContent = 'Pause';
                elements.pauseButton.disabled = true;
                simulationPaused = false;
            }
        }

        async function fetchApi(endpoint, options = {}) {
            try {
                const response = await fetch(endpoint, options);
                if (!response.ok) {
                    let errorMsg = `HTTP error! status: ${response.status}`;
                    try {
                        const errorData = await response.json();
                        errorMsg = errorData.message || errorMsg;
                         if (errorData.expected_configuration) {
                              elements.overrideButton.style.display = 'inline-flex';
                              errorMsg += ` Expected ${errorData.expected_configuration.num_floors} floors, ${errorData.expected_configuration.num_elevators} elevators. Click Override to force.`;
                         } else {
                              elements.overrideButton.style.display = 'none';
                         }

                    } catch (e) { }
                    throw new Error(errorMsg);
                }
                return await response.json();
            } catch (error) {
                console.error(`Error fetching ${endpoint}:`, error);
                throw error;
            }
        }

        async function updatePassengerRate(rate) {
            try {
                const result = await fetchApi('/update_passenger_rate', {
                    method: 'POST', headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ rate: parseFloat(rate) })
                });
                showStatus(`Passenger rate updated to ${result.new_rate.toFixed(2)}`);
            } catch (error) {
                showStatus(`Error updating rate: ${error.message}`, true);
            }
        }

        async function updateSimulationSpeed(speed) {
            try {
                const result = await fetchApi('/update_simulation_speed', {
                    method: 'POST', headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ speed: parseFloat(speed) })
                });
                showStatus(`Simulation speed updated to ${result.new_speed.toFixed(1)} s/step`);
            } catch (error) {
                showStatus(`Error updating speed: ${error.message}`, true);
            }
        }

        async function updateMaxSteps(steps) {
            try {
                const result = await fetchApi('/update_max_steps', {
                    method: 'POST', headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ max_steps: parseInt(steps) })
                });
                showStatus(`Max steps updated to ${result.new_max_steps}`);
            } catch (error) {
                showStatus(`Error updating max steps: ${error.message}`, true);
            }
        }

        async function loadModel() {
            const file = elements.modelFileInput.files[0];
            if (!file) {
                showStatus('Please select a model file first', true);
                return;
            }
            elements.loadModelBtn.disabled = true;
            elements.loadedModelInfo.textContent = 'Loading...';

            const formData = new FormData();
            formData.append('model_file', file);

            try {
                const result = await fetchApi('/load_model', { method: 'POST', body: formData });
                showStatus(result.message);
                modelLoaded = true;
                elements.numFloorsInput.value = result.num_floors;
                elements.numElevatorsInput.value = result.num_elevators;
                elements.numFloorsInput.disabled = true;
                elements.numElevatorsInput.disabled = true;
                elements.loadedModelInfo.textContent = `Loaded (${result.num_floors}F/${result.num_elevators}E)`;
                initializeVisualization(result.num_floors, result.num_elevators);
                resetCharts();
                setSimulationState(false);
                elements.startBtn.disabled = false;
            } catch (error) {
                showStatus(`Error loading model: ${error.message}`, true);
                 elements.loadedModelInfo.textContent = '';
                 modelLoaded = false;
                 elements.numFloorsInput.disabled = false;
                 elements.numElevatorsInput.disabled = false;
                 elements.loadModelBtn.disabled = false;
            }
        }

        async function startSimulation() {
            console.log('Attempting to start simulation...');
            elements.startBtn.disabled = true;

             await Promise.all([
                 updatePassengerRate(elements.rateSlider.value),
                 updateSimulationSpeed(elements.speedSlider.value),
                 updateMaxSteps(elements.maxStepsSlider.value)
             ]);

            try {
                const result = await fetchApi('/start_simulation', { method: 'POST' });
                console.log('Simulation start response:', result);
                setSimulationState(true);
                resetCharts();
                showStatus('Simulation started');
            } catch (error) {
                showStatus(`Error starting simulation: ${error.message}`, true);
                elements.startBtn.disabled = false;
            }
        }

        async function stopSimulation() {
            console.log('Stopping simulation...');
            elements.stopBtn.disabled = true;
            try {
                const result = await fetchApi('/stop_simulation', { method: 'POST' });
                setSimulationState(false);
                showStatus('Simulation stopped');
            } catch (error) {
                showStatus(`Error stopping simulation: ${error.message}`, true);
                setSimulationState(false);
            }
        }

        async function togglePause() {
            const isPausing = !simulationPaused;
            elements.pauseButton.disabled = true;
            try {
                const result = await fetchApi('/pause_simulation', {
                    method: 'POST', headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ pause: isPausing })
                });
                simulationPaused = result.paused;
                elements.pauseButton.textContent = simulationPaused ? 'Resume' : 'Pause';
                showStatus(simulationPaused ? 'Simulation paused' : 'Simulation resumed');
            } catch (error) {
                showStatus(`Error toggling pause: ${error.message}`, true);
            } finally {
                elements.pauseButton.disabled = !simulationRunning;
            }
        }

        async function resetSimulation() {
             console.log('Resetting simulation...');
             try {
                 if (simulationRunning) {
                     await stopSimulation();
                 }
                 const result = await fetchApi('/reset_simulation', { method: 'POST' });
                 showStatus('Simulation reset');

                 modelLoaded = false;
                 setSimulationState(false);
                 resetCharts();

                 elements.modelFileInput.value = '';
                 elements.loadModelBtn.disabled = true;
                 elements.loadedModelInfo.textContent = '';
                 elements.modelFileInput.disabled = false;

                 showWelcomeModal();
                 elements.startBtn.disabled = true;

             } catch (error) {
                 showStatus(`Error resetting simulation: ${error.message}`, true);
             }
         }

        async function requestElevator(floorNumber) {
            console.log(`Requesting elevator at floor ${floorNumber}`);
            try {
                 const button = elements.floorsDiv.querySelector(`.floor[data-floor-index="${floorNumber}"] .floor-button`);
                 if (button) button.disabled = true;

                const result = await fetchApi('/request_elevator', {
                    method: 'POST', headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ floor: floorNumber })
                });
            } catch (error) {
                showStatus(`Request error: ${error.message}`, true);
            } finally {
                 setTimeout(() => {
                     const button = elements.floorsDiv.querySelector(`.floor[data-floor-index="${floorNumber}"] .floor-button`);
                     if (button) button.disabled = false;
                 }, 500);
            }
        }

         async function updateConfiguration(override = false) {
             const numElevators = parseInt(elements.numElevatorsInput.value);
             const numFloors = parseInt(elements.numFloorsInput.value);
             elements.overrideButton.style.display = 'none';

             console.log(`Updating config - E: ${numElevators}, F: ${numFloors}, Override: ${override}`);
             if (isNaN(numElevators) || numElevators < 1 || numElevators > 10 ||
                 isNaN(numFloors) || numFloors < 2 || numFloors > 20) {
                 showStatus('Invalid input: Elevators (1-10), Floors (2-20)', true, elements.configStatusMessage);
                 return false;
             }

             try {
                 const result = await fetchApi('/update_configuration', {
                     method: 'POST',
                     headers: {'Content-Type': 'application/json'},
                     body: JSON.stringify({
                         num_elevators: numElevators,
                         num_floors: numFloors,
                         override: override
                     })
                 });
                 console.log('Config update successful:', result);
                 hideWelcomeModal();
                 showStatus('Configuration updated. Ready to start.', false, elements.statusMessage);
                 initializeVisualization(result.num_floors, result.num_elevators);
                 resetCharts();
                 setSimulationState(false);
                 elements.startBtn.disabled = false;
                 return true;
             } catch (error) {
                 showStatus(error.message, true, elements.configStatusMessage);
                 return false;
             }
         }

        function showWelcomeModal() {
            elements.welcomeModal.style.display = 'flex';
            elements.configStatusMessage.textContent = '';
            elements.configStatusMessage.classList.remove('visible', 'error', 'success');
            elements.overrideButton.style.display = 'none';

            elements.numElevatorsInput.disabled = modelLoaded;
            elements.numFloorsInput.disabled = modelLoaded;
        }
        function hideWelcomeModal() {
            elements.welcomeModal.style.display = 'none';
        }
        function showConfigModal() {
            if (simulationRunning) {
                stopSimulation();
            }
            showWelcomeModal();
        }

        function showEpisodeSummary(data) {
            document.getElementById('totalReward').textContent = data.total_reward ?? '-';
            document.getElementById('avgReward').textContent = data.avg_reward ?? '-';
            document.getElementById('passengersServed').textContent = data.total_passengers_served ?? '-';
            document.getElementById('passengersGenerated').textContent = data.total_passengers_generated ?? '-';
            document.getElementById('completionRate').textContent = `${data.completion_rate ?? '-'}%`;
            document.getElementById('avgWaitTime').textContent = `${data.avg_waiting_time ?? '-'} steps`;
            document.getElementById('minWaitTime').textContent = `${data.min_waiting_time ?? '-'} steps`;
            document.getElementById('maxWaitTime').textContent = `${data.max_waiting_time ?? '-'} steps`;
            document.getElementById('totalSteps').textContent = data.total_steps ?? '-';
            document.getElementById('avgPassengersPerStep').textContent = data.avg_passengers_per_step ?? '-';
             document.getElementById('modeUsed').textContent = data.using_model ? 'Trained Model' : 'Random';

            elements.episodeSummaryModal.style.display = 'flex';
        }

        function startNewEpisode() {
            elements.episodeSummaryModal.style.display = 'none';
            startSimulation();
        }

        function initializeVisualization(numFloors, numElevators) {
            console.log(`Initializing visualization - F: ${numFloors}, E: ${numElevators}`);
            try {
                elements.floorsDiv.innerHTML = '';
                const existingShafts = elements.buildingDiv.querySelectorAll('.elevator-shaft');
                existingShafts.forEach(shaft => shaft.remove());

                for (let i = 0; i < numFloors; i++) {
                    const floor = document.createElement('div');
                    floor.className = 'floor';
                    floor.dataset.floorIndex = i;
                    floor.innerHTML = `
                        <div class="floor-info">
                            <span class="floor-number">Floor ${i}</span>
                            <span class="waiting-count" id="waiting-${i}">Waiting: 0</span>
                        </div>
                        <div class="floor-button-container">
                            <button class="floor-button" onclick="requestElevator(${i})">â–²</button>
                        </div>
                    `;
                    elements.floorsDiv.appendChild(floor);
                }

                const elevatorSizeDesktop = parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--elevator-size-desktop'));
                const shaftWidth = elevatorSizeDesktop + 10;
                const totalShaftSpace = shaftWidth * numElevators;
                elements.buildingDiv.style.paddingRight = `${totalShaftSpace + 10}px`;

                for (let i = 0; i < numElevators; i++) {
                    const shaft = document.createElement('div');
                    shaft.className = 'elevator-shaft';
                    shaft.style.right = `${(numElevators - 1 - i) * shaftWidth + 5}px`;

                    const elevator = document.createElement('div');
                    elevator.className = 'elevator';
                    elevator.id = `elevator-${i}`;
                    elevator.innerHTML = `
                        <span class="elevator-id">E${i + 1}</span>
                        <span class="direction">â€¢</span>
                        <span class="passenger-count">0</span>
                    `;
                    shaft.appendChild(elevator);
                    elements.buildingDiv.appendChild(shaft);
                }

                console.log('Visualization initialized');

            } catch (error) {
                console.error('Error initializing visualization:', error);
                showStatus('Error initializing visualization: ' + error.message, true);
            }
        }

        function initializeCharts() {
            const chartOptions = {
                responsive: true,
                maintainAspectRatio: false,
                animation: false,
                scales: { y: { beginAtZero: true } },
                plugins: { legend: { display: true } }
            };

            const lineChartBase = { type: 'line', options: {...chartOptions, scales: {y: {beginAtZero: true, title:{display:true}}}}, data: { labels: [], datasets: [] } };

            charts.passengers = new Chart(document.getElementById('passengersChart').getContext('2d'), {
                ...lineChartBase,
                 options: { ...lineChartBase.options, scales: { y: {...lineChartBase.options.scales.y, title: {text: 'Passengers'} } }, plugins: {...lineChartBase.options.plugins, title: { display: true, text: 'Passenger Distribution'}}},
                data: { labels: [], datasets: [
                    { label: 'In Elevators', data: [], borderColor: 'var(--primary)', backgroundColor: 'rgba(67, 97, 238, 0.1)', tension: 0.3, fill: true },
                    { label: 'Waiting', data: [], borderColor: 'var(--danger)', backgroundColor: 'rgba(247, 37, 133, 0.1)', tension: 0.3, fill: true }
                ] }
            });

            charts.reward = new Chart(document.getElementById('rewardChart').getContext('2d'), {
                ...lineChartBase,
                options: { ...lineChartBase.options, scales: { y: { title: { display: true, text: 'Reward' } } }, plugins: {...lineChartBase.options.plugins, title: { display: true, text: 'Reward per Step'}}},
                data: { labels: [], datasets: [{ label: 'Reward', data: [], borderColor: 'var(--success)', backgroundColor: 'rgba(76, 201, 240, 0.1)', tension: 0.3, fill: true }] }
            });

            charts.waitTime = new Chart(document.getElementById('waitTimeChart').getContext('2d'), {
                 ...lineChartBase,
                options: { ...lineChartBase.options, scales: { y: {...lineChartBase.options.scales.y, title: { display: true, text: 'Avg Wait (Steps)' } } }, plugins: {...lineChartBase.options.plugins, title: { display: true, text: 'Average Wait Time'}}},
                data: { labels: [], datasets: [{ label: 'Avg Wait Time', data: [], borderColor: 'var(--secondary)', backgroundColor: 'rgba(58, 12, 163, 0.1)', tension: 0.3, fill: true }] }
            });
            console.log("Charts initialized");
        }

        function applyTheme(theme) {
            document.documentElement.setAttribute('data-theme', theme);
            localStorage.setItem('theme', theme);
            elements.themeToggleBtn.textContent = theme === 'dark' ? 'â˜€ï¸' : 'ðŸŒ™';
            updateChartTheme(theme);
        }

        function toggleTheme() {
            const currentTheme = document.documentElement.getAttribute('data-theme') || 'light';
            const newTheme = currentTheme === 'light' ? 'dark' : 'light';
            applyTheme(newTheme);
        }

        function initializeTheme() {
            const savedTheme = localStorage.getItem('theme');
            const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
            let initialTheme = 'light';

            if (savedTheme) {
                initialTheme = savedTheme;
            } else if (prefersDark) {
                initialTheme = 'dark';
            }
            applyTheme(initialTheme);

            window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {
                if (!localStorage.getItem('theme')) {
                    applyTheme(event.matches ? 'dark' : 'light');
                }
            });
        }

        function updateChartTheme(theme) {
            const isDark = theme === 'dark';
            const gridColor = isDark ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)';
            const labelColor = isDark ? '#a1a1aa' : '#666';
            const titleColor = isDark ? '#e0e0e0' : '#2b2d42';

            Object.values(charts).forEach(chart => {
                if (chart) {
                    chart.options.scales.x.ticks.color = labelColor;
                    chart.options.scales.x.grid.color = gridColor;
                    chart.options.scales.y.ticks.color = labelColor;
                    chart.options.scales.y.grid.color = gridColor;
                    if(chart.options.scales.y.title) chart.options.scales.y.title.color = labelColor;
                    chart.options.plugins.legend.labels.color = labelColor;
                    chart.options.plugins.title.color = titleColor;
                    chart.update('none');
                }
            });
        }

        elements.themeToggleBtn.addEventListener('click', toggleTheme);

        document.addEventListener('DOMContentLoaded', () => {
            initializeCharts();
            initializeTheme();
            showWelcomeModal();
            setSimulationState(false);
            elements.startBtn.disabled = true;
        });

    </script>
</body>
</html>